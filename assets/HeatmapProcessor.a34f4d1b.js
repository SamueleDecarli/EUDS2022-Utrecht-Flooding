var O=Object.defineProperty,g=Object.defineProperties;var v=Object.getOwnPropertyDescriptors;var u=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable;var y=(i,e,s)=>e in i?O(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s,m=(i,e)=>{for(var s in e||(e={}))E.call(e,s)&&y(i,s,e[s]);if(u)for(var s of u(e))x.call(e,s)&&y(i,s,e[s]);return i},T=(i,e)=>g(i,v(e));import{g as C,n as M,D,r as I,d7 as w,sO as R}from"./vendor.e1f4f720.js";import{q as b}from"./enums.ba1e21c6.js";import{p as q,l as n}from"./tileUtils.c7af0c5d.js";class o{constructor(e,s){this.offset=e,this.extent=s}}function z(i){const e=i.key,s=new Map,a=256,t=b,r=i.tileInfoView.tileInfo.isWrappable;return s.set(n(e,-1,-1,r).id,new o([-t,-t],[t-a,t-a,t,t])),s.set(n(e,0,-1,r).id,new o([0,-t],[0,t-a,t,t])),s.set(n(e,1,-1,r).id,new o([t,-t],[0,t-a,a,t])),s.set(n(e,-1,0,r).id,new o([-t,0],[t-a,0,t,t])),s.set(n(e,1,0,r).id,new o([t,0],[0,0,a,t])),s.set(n(e,-1,1,r).id,new o([-t,t],[t-a,0,t,a])),s.set(n(e,0,1,r).id,new o([0,t],[0,0,t,a])),s.set(n(e,1,1,r).id,new o([t,t],[0,0,a,a])),s}let c=class extends q{constructor(){super(...arguments),this.type="heatmap",this._tileKeyToFeatureSets=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])}async update(i,e){const s=e.schema.processors[0];s.type==="heatmap"&&D(this._schema,s)&&(i.mesh=!0,this._schema=s)}onTileUpdate(i){for(const e of i.removed)this._tileKeyToFeatureSets.delete(e.key.id)}onTileClear(i){const e={clear:!0};return this._tileKeyToFeatureSets.delete(i.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:i.id,data:e})}async onTileMessage(i,e,s){this._tileKeyToFeatureSets.has(i.key.id)||this._tileKeyToFeatureSets.set(i.key.id,new Map);const a=this._tileKeyToFeatureSets.get(i.key.id);if(I(e.addOrUpdate)&&e.addOrUpdate.hasFeatures&&a.set(e.addOrUpdate.instance,e),e.end){const t=[],r=z(i);this._tileKeyToFeatureSets.forEach((f,d)=>{if(d===i.key.id)f.forEach(l=>w(l.addOrUpdate,h=>t.push(h)));else if(r.has(d)){const l=r.get(d),[h,_]=l.offset;f.forEach(F=>w(F.addOrUpdate,S=>{const U=S.transform(h,_,1,1);t.push(U)}))}});const p=R(t,this._schema.mesh,512,512),k={tileKey:i.key.id,intensityInfo:p},K=[p.matrix];return this.remoteClient.invoke("tileRenderer.onTileData",k,T(m({},s),{transferList:K}))}}onTileError(i,e,s){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:i.id,error:e},s)}};c=C([M("esri.views.2d.layers.features.processors.HeatmapProcessor")],c);const W=c;export{W as default};
